
{% extends "client_page.html" %}

{% block title %}Audit Execution{% endblock %}

{% block content %}
<style>
    .accordion-button {
        background-color: #e7f1ff;
        color: #007bff;
        font-weight: bold;
    }
    .period-banner {
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        border-left: 4px solid #0d6efd;
    }
    .task-status-Completed {
        background-color: #d4edda !important;
    }
    .task-status-InProgress {
        background-color: #fff3cd !important;
    }
    .task-status-Pending {
        background-color: #f8f9fa !important;
    }
    .stats-card {
        transition: transform 0.3s;
        cursor: pointer;
    }
    .stats-card:hover {
        transform: translateY(-5px);
    }
    .loading-spinner {
        display: none;
    }
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }
    .editing {
        padding: 5px !important;
        background-color: #fff !important;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        min-height: 2.2em;
    }
    .editing:focus {
        outline: none;
        box-shadow: inset 0 0 0 2px #007bff;
    }
    .preview-content {
    font-size: 0.9rem;
}

.preview-content h4 {
    color: #2c3e50;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
}

.finding-item {
    padding: 0.5rem;
    border-left: 3px solid #007bff;
    background-color: #f8f9fa;
}

.finding-item strong {
    color: #2c3e50;
}

#reportPreview {
    background-color: white;
    border-radius: 4px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}

.modal-xl {
    max-width: 1140px;
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}
.task-overdue .task-due-date {
    color: #dc3545;
    font-weight: bold;
}

.due-soon .task-due-date {
    color: #ffc107;
    font-weight: bold;
}

.task-completed .task-due-date {
    color: #28a745;
}
</style>

<div class="container-fluid px-4">
    {% if not start_date or not end_date %}
        <div class="alert alert-warning mt-4">
            <h5><i class="fas fa-exclamation-triangle"></i> No Audit Period Selected</h5>
            <p>Please <a href="{{ url_for('select_period', client_id=client._id) }}" class="alert-link">select an audit period</a> to proceed with audit execution.</p>
        </div>
    {% else %}
        <!-- Period Information -->
        <div class="period-banner mt-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-0">Audit Period: {{ start_date }} to {{ end_date }}</h4>
                    <p class="mb-0 text-muted">Client: {{ client.company_name }}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                            <i class="fas fa-file-export"></i> Generate Report
                        </button>
                        <a href="{{ url_for('select_period', client_id=client._id) }}" class="btn btn-outline-primary">
                            <i class="fas fa-calendar-alt"></i> Change Period
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Clone Execution Modal -->
<!-- Clone Execution Modal -->
<div class="modal fade" id="cloneExecutionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Clone Audit Execution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cloneExecutionForm">
                    <div class="mb-3">
                        <label class="form-label">Source Period</label>
                        <select class="form-select" id="sourcePeriod" required>
                            <option value="">Select source period...</option>
                            {% for period in available_periods %}
                                <option value="{{ period.period_start }}|{{ period.period_end }}">
                                    {{ period.period_start }} to {{ period.period_end }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Start Date</label>
                        <input type="date" class="form-control" id="newStartDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New End Date</label>
                        <input type="date" class="form-control" id="newEndDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="cloneExecutionBtn">Clone Execution</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Clone Button to Period Banner -->
<div class="period-banner mt-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h4 class="mb-0">Audit Period: {{ start_date }} to {{ end_date }}</h4>
            <p class="mb-0 text-muted">Client: {{ client.company_name }}</p>
        </div>
        <div class="col-md-4 text-end">
            <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#cloneExecutionModal">
                <i class="fas fa-clone"></i> Clone Execution
            </button>
            <a href="{{ url_for('select_period', client_id=client._id) }}" class="btn btn-outline-primary">
                <i class="fas fa-calendar-alt"></i> Change Period
            </a>
        </div>
    </div>
</div>

        <!-- Statistics Cards -->
        <div class="row g-4 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="card bg-primary text-white h-100 stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white">Total Tasks</h6>
                                <h2 class="mb-0" id="totalTasks">0</h2>
                            </div>
                            <i class="fas fa-tasks fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-success text-white h-100 stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white">Completed</h6>
                                <h2 class="mb-0" id="completedTasks">0</h2>
                            </div>
                            <i class="fas fa-check-circle fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-warning text-white h-100 stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white">In Progress</h6>
                                <h2 class="mb-0" id="inProgressTasks">0</h2>
                            </div>
                            <i class="fas fa-spinner fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6">
                <div class="card bg-danger text-white h-100 stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white">Pending</h6>
                                <h2 class="mb-0" id="pendingTasks">0</h2>
                            </div>
                            <i class="fas fa-clock fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="accordion" id="auditExecutionAccordion">
                    {% for execution in audit_execution_data %}
                    <div class="accordion-item mb-3">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#collapse{{ loop.index }}">
                                <i class="fas fa-folder me-2"></i>
                                {{ execution.scope_area }}
                                <span class="badge bg-primary ms-2" id="taskCount-{{ loop.index }}">
                                    {{ execution.tasks|length }} Tasks
                                </span>
                            </button>
                        </h2>
                        
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" 
                             data-bs-parent="#auditExecutionAccordion">
                            <div class="accordion-body">
                                <!-- Action Buttons -->
                                <div class="mb-3">
                                    <button type="button" class="btn btn-secondary me-2 generate-procedures" 
                                            data-scope-area="{{ execution.scope_area }}"
                                            data-start-date="{{ start_date }}"
                                            data-end-date="{{ end_date }}">
                                        <i class="fas fa-magic"></i> Generate Procedures
                                    </button>
                                    <button type="button" class="btn btn-primary" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#addTaskModal{{ loop.index }}"
                                            data-scope-area="{{ execution.scope_area }}">
                                        <i class="fas fa-plus"></i> Add New Task
                                    </button>
                                </div>

                                <!-- Tasks Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover border">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Task Name</th>
                                                <th>Procedure</th>
                                                <th>Audit Evidence</th>
                                                <th>Comments</th>
                                                <th>Status</th>
                                                <th>Team Member</th>
                                                <th>Due Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="taskList{{ loop.index }}">
                                            {% for task in execution.tasks %}
                                            <tr data-task-id="{{ task._id }}"
                                                class="task-status-{{ task.status|replace(' ', '') }}">
                                                <td class="task-name">{{ task.task_name }}</td>
                                                <td class="task-procedure">{{ task.procedure }}</td>
                                                <td class="task-evidence">{{ task.audit_evidence }}</td>
                                                <td class="task-comments">{{ task.comments }}</td>
                                                <td class="task-status">
                                                    <span class="badge {% if task.status == 'Completed' %}bg-success
                                                                   {% elif task.status == 'In Progress' %}bg-warning
                                                                   {% else %}bg-secondary{% endif %}">
                                                        {{ task.status }}
                                                    </span>
                                                </td>
                                                <td class="task-member">{{ task.allocated_team_member }}</td>
                                                <td class="task-due-date">
                                                    {% if task.due_date %}
                                                        <span class="{% if task.due_date < now|string %}text-danger{% endif %}">
                                                            {{ task.due_date }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                </td>
                                                <td class="task-member">{{ task.allocated_team_member }}</td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button type="button" class="btn btn-outline-primary edit-task" title="Edit Task">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-danger delete-task" title="Delete Task">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-success upload-doc" title="Upload Supporting Document" 
                                                                onclick="openUploadModal('{{ task._id }}')">
                                                            <i class="fas fa-file-upload"></i>
                                                        </button>
                                                        {% if task.supporting_docs %}
                                                        <button type="button" class="btn btn-outline-info view-docs" title="View Documents"
                                                                onclick="viewDocuments('{{ task._id }}')">
                                                            <i class="fas fa-folder-open"></i>
                                                            <span class="badge bg-secondary">{{ task.supporting_docs|length }}</span>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Add Task Modal -->
                                <div class="modal fade" id="addTaskModal{{ loop.index }}" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">
                                                    Add New Task - {{ execution.scope_area }}
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <form id="taskForm{{ loop.index }}" class="needs-validation" novalidate>
                                                    <input type="hidden" name="scope_area" value="{{ execution.scope_area }}">
                                                    <input type="hidden" name="start_date" value="{{ start_date }}">
                                                    <input type="hidden" name="end_date" value="{{ end_date }}">

                                                    <div class="mb-3">
                                                        <label class="form-label">Task Name*</label>
                                                        <input type="text" class="form-control" name="task_name" required>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label class="form-label">Procedure</label>
                                                        <textarea class="form-control" name="procedure" rows="3"></textarea>
                                                    </div>

                                                    <!-- Add this inside the Add Task Modal form -->
                                                    <div class="row">
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Status</label>
                                                                <select class="form-select" name="status">
                                                                    <option value="Pending">Pending</option>
                                                                    <option value="In Progress">In Progress</option>
                                                                    <option value="Completed">Completed</option>
                                                                </select>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <div class="mb-3">
                                                                <label class="form-label">Due Date*</label>
                                                                <input type="date" class="form-control" name="due_date" required
                                                                    min="{{ start_date }}" max="{{ end_date }}">
                                                                <small class="text-muted">Must be within audit period</small>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label class="form-label">Team Member</label>
                                                        <select class="form-select" name="allocated_team_member">
                                                            <option value="">Select Team Member</option>
                                                            {% for user in team_users %}
                                                                <option value="{{ user.username }}">{{ user.username }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>

                                                    <div class="mb-3">
                                                        <label class="form-label">Comments</label>
                                                        <textarea class="form-control" name="comments" rows="2"></textarea>
                                                    </div>
                                                </form>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Cancel
                                                </button>
                                                <button type="button" class="btn btn-primary add-task" 
                                                        data-form-id="taskForm{{ loop.index }}">
                                                    Add Task
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Toast Notification -->
<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toastTitle"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<!-- First, add this HTML for the modal just before your existing script tag -->
<div class="modal fade" id="generateReportModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Generate Audit Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Report Options -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Report Format</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="reportFormat" id="formatWord" value="word" checked>
                                    <label class="form-check-label" for="formatWord">
                                        <i class="fas fa-file-word text-primary"></i> Word Document
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="reportFormat" id="formatExcel" value="excel">
                                    <label class="form-check-label" for="formatExcel">
                                        <i class="fas fa-file-excel text-success"></i> Excel Spreadsheet
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">Report Sections</h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="includeExecutiveSummary" checked>
                                    <label class="form-check-label" for="includeExecutiveSummary">
                                        Executive Summary
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="includeDetailedFindings" checked>
                                    <label class="form-check-label" for="includeDetailedFindings">
                                        Detailed Findings
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeRecommendations" checked>
                                    <label class="form-check-label" for="includeRecommendations">
                                        Recommendations
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Report Preview -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Report Preview</h6>
                    </div>
                    <div class="card-body">
                        <div id="reportPreview" class="border p-3" style="max-height: 400px; overflow-y: auto;">
                            <!-- Preview content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="downloadReport">
                    <i class="fas fa-download me-2"></i>Download Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update the Upload Document Modal -->
<div class="modal fade" id="uploadDocModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Supporting Documents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadDocForm" enctype="multipart/form-data">
                    <input type="hidden" id="taskIdForUpload" name="task_id">
                    <div class="mb-3">
                        <label class="form-label">Document Title</label>
                        <input type="text" class="form-control" name="doc_title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="doc_description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Files</label>
                        <input type="file" class="form-control" name="documents" multiple required>
                        <small class="text-muted">Allowed types: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (Max 15MB per file)</small>
                    </div>
                    <div id="selectedFiles" class="mt-2">
                        <!-- Selected files will be listed here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadDocuments()">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Update the View Documents Modal -->
<div class="modal fade" id="viewDocsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supporting Documents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="docsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>File Type</th>
                                <th>Size</th>
                                <th>Description</th>
                                <th>Uploaded On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="uploadMoreDocuments()">
                    <i class="fas fa-plus"></i> Add More Documents
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Update the period banner button to trigger the modal -->


<script>
document.addEventListener('DOMContentLoaded', function() {
    updateTaskCounters();
    initializeEventListeners();
    initializeReportGeneration();  // Add this new function call
});

// Add this new function for report button initialization
function initializeReportGeneration() {
    const reportModal = document.getElementById('generateReportModal');
    const downloadBtn = document.getElementById('downloadReport');
    const previewDiv = document.getElementById('reportPreview');
    
    if (reportModal) {
        // Update preview when modal opens
        reportModal.addEventListener('show.bs.modal', function() {
            updateReportPreview();
        });
        
        // Handle report format changes
        document.querySelectorAll('input[name="reportFormat"]').forEach(radio => {
            radio.addEventListener('change', updateReportPreview);
        });
        
        // Handle section toggle changes
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateReportPreview);
        });
        
        // Handle download button click
        if (downloadBtn) {
            downloadBtn.addEventListener('click', generateAndDownloadReport);
        }
    }
}

function updateReportPreview() {
    const previewDiv = document.getElementById('reportPreview');
    const format = document.querySelector('input[name="reportFormat"]:checked').value;
    const includeSummary = document.getElementById('includeExecutiveSummary').checked;
    const includeFindings = document.getElementById('includeDetailedFindings').checked;
    const includeRecommendations = document.getElementById('includeRecommendations').checked;
        // Gather statistics
        const stats = {
        total: document.getElementById('totalTasks').textContent,
        completed: document.getElementById('completedTasks').textContent,
        inProgress: document.getElementById('inProgressTasks').textContent,
        pending: document.getElementById('pendingTasks').textContent
    };
    
    let previewContent = '<div class="preview-content">';
    
    // Add Executive Summary section if selected
    if (includeSummary) {
        previewContent += `
            <h4>Executive Summary</h4>
            <div class="mb-3">
                <p>Audit Status Overview:</p>
                <ul>
                    <li>Total Tasks: ${stats.total}</li>
                    <li>Completed: ${stats.completed}</li>
                    <li>In Progress: ${stats.inProgress}</li>
                    <li>Pending: ${stats.pending}</li>
                </ul>
            </div>
        `;
    }
    
    // Add Detailed Findings section if selected
    if (includeFindings) {
        previewContent += `
            <h4>Detailed Findings</h4>
            <div class="mb-3">
                ${generateFindingsPreview()}
            </div>
        `;
    }
    
    // Add Recommendations section if selected
    if (includeRecommendations) {
        previewContent += `
            <h4>Recommendations</h4>
            <div class="mb-3">
                <p>Based on the audit findings, the following recommendations are provided:</p>
                ${generateRecommendationsPreview()}
            </div>
        `;
    }
    
    previewContent += '</div>';
    previewDiv.innerHTML = previewContent;
}

function generateFindingsPreview() {
    let findings = '';
    document.querySelectorAll('[data-task-id]').forEach(row => {
        const status = row.querySelector('.task-status').textContent.trim();
        const taskName = row.querySelector('.task-name').textContent.trim();
        const comments = row.querySelector('.task-comments').textContent.trim();
        
        if (comments) {
            findings += `
                <div class="finding-item mb-2">
                    <strong>${taskName}</strong> (${status})
                    <p class="mb-0 text-muted">${comments}</p>
                </div>
            `;
        }
    });
    return findings || '<p>No detailed findings available.</p>';
}

function generateRecommendationsPreview() {
    let recommendations = '<ul>';
    document.querySelectorAll('[data-task-id]').forEach(row => {
        const status = row.querySelector('.task-status').textContent.trim();
        if (status !== 'Completed') {
            const taskName = row.querySelector('.task-name').textContent.trim();
            recommendations += `
                <li>Complete the pending task: ${taskName}</li>
            `;
        }
    });
    recommendations += '</ul>';
    return recommendations;
}

function generateAndDownloadReport() {
    const downloadBtn = document.getElementById('downloadReport');
    const format = document.querySelector('input[name="reportFormat"]:checked').value;
    const clientId = getClientIdFromUrl();
    
    // Extract dates from the period banner
    const startDate = document.querySelector('.period-banner').textContent.match(/Audit Period: (.*?) to/)[1].trim();
    const endDate = document.querySelector('.period-banner').textContent.match(/to (.*?)$/)[1].trim();
    
    try {
        // Show loading state
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
        
        // Choose endpoint based on format
        const endpoint = format === 'excel' 
            ? `/client/${clientId}/export_audit_report_excel`
            : `/client/${clientId}/export_audit_report`;
        
        // Add query parameters
        const url = `${endpoint}?start_date=${startDate}&end_date=${endDate}`;
        
        // Trigger download
        window.location.href = url;
        
        // Show success message
        showToast('Success', 'Report generation started. Your download will begin shortly.');
        
        // Close modal after delay
        setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('generateReportModal'));
            if (modal) modal.hide();
        }, 1500);
        
    } catch (error) {
        console.error('Error generating report:', error);
        showToast('Error', 'Failed to generate report. Please try again.');
    } finally {
        // Reset button after delay
        setTimeout(() => {
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = '<i class="fas fa-download me-2"></i>Download Report';
        }, 3000);
    }
}

function getAuditPeriodDates() {
    const periodBanner = document.querySelector('.period-banner');
    if (!periodBanner) {
        throw new Error('Period banner not found');
    }

    const text = periodBanner.textContent;
    const startMatch = text.match(/Audit Period: (.*?) to/);
    const endMatch = text.match(/to (.*?)(?=\n|$)/);

    if (!startMatch || !endMatch) {
        throw new Error('Could not extract audit period dates');
    }

    return {
        startDate: startMatch[1].trim(),
        endDate: endMatch[1].trim()
    };
}

function checkRequiredElements() {
    const requiredElements = {
        downloadBtn: document.getElementById('downloadReport'),
        formatRadios: document.querySelector('input[name="reportFormat"]:checked'),
        executiveSummary: document.getElementById('includeExecutiveSummary'),
        detailedFindings: document.getElementById('includeDetailedFindings'),
        recommendations: document.getElementById('includeRecommendations')
    };

    const missing = Object.entries(requiredElements)
        .filter(([_, element]) => !element)
        .map(([name]) => name);

    if (missing.length > 0) {
        throw new Error(`Missing required elements: ${missing.join(', ')}`);
    }

    return requiredElements;
}

function initializeEventListeners() {
    // Event delegation for edit and delete buttons
    document.addEventListener('click', function(event) {
        // Edit button handler
        if (event.target.closest('.edit-task')) {
            const row = event.target.closest('tr');
            makeRowEditable(row);
        }

        // Delete button handler
        if (event.target.closest('.delete-task')) {
            handleDeleteTask(event.target.closest('tr'));
        }

        // Save changes handler
        if (event.target.closest('.save-changes')) {
            const row = event.target.closest('tr');
            saveChanges(row);
        }

        // Cancel edit handler
        if (event.target.closest('.cancel-edit')) {
            const row = event.target.closest('tr');
            cancelEdit(row);
        }

        
    });

    // Generate procedures handler
    document.querySelectorAll('.generate-procedures').forEach(button => {
        button.addEventListener('click', async function() {
            const scopeArea = this.getAttribute('data-scope-area');
            const startDate = this.getAttribute('data-start-date');
            const endDate = this.getAttribute('data-end-date');
            const clientId = getClientIdFromUrl();

            try {
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                showToast('Info', 'Generating procedures...');

                const response = await fetch(
                    `/client/${clientId}/generate_audit_procedure/${encodeURIComponent(scopeArea)}?start_date=${startDate}&end_date=${endDate}`,
                    { method: 'POST' }
                );

                const data = await response.json();
                if (data.success) {
                    showToast('Success', `Successfully generated ${data.count || ''} procedures!`);
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error(data.error || 'Failed to generate procedures');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', error.message || 'Failed to generate procedures');
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-magic"></i> Generate Procedures';
            }
        });
    });
}
document.querySelectorAll('.add-task').forEach(button => {
        button.addEventListener('click', async function() {
            const formId = this.getAttribute('data-form-id');
            const form = document.getElementById(formId);
            
            if (!form) {
                showToast('Error', 'Form not found');
                return;
            }

            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            try {
                const formData = new FormData(form);
                const clientId = getClientIdFromUrl();
                const startDate = formData.get('start_date');
                const endDate = formData.get('end_date');

                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

                const response = await fetch(
                    `/client/${clientId}/add_audit_task?start_date=${startDate}&end_date=${endDate}`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );

                const data = await response.json();
                if (data.success) {
                    showToast('Success', 'Task added successfully!');
                    // Close the modal if it exists
                    const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
                    if (modal) {
                        modal.hide();
                    }
                    location.reload();
                } else {
                    throw new Error(data.error || 'Failed to add task');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error', error.message || 'Failed to add task');
            } finally {
                this.disabled = false;
                this.innerHTML = 'Add Task';
            }
        });
    });

    async function generateAndDownloadReport() {
    try {
        const downloadBtn = document.getElementById('downloadReport');
        if (!downloadBtn) {
            throw new Error('Download button not found');
        }

        // Get options and format
        const format = document.querySelector('input[name="reportFormat"]:checked')?.value;
        if (!format) {
            throw new Error('Please select a report format');
        }

        // Get dates using helper function
        const { startDate, endDate } = getAuditPeriodDates();
        const clientId = getClientIdFromUrl();

        // Get selected sections
        const options = {
            includeSummary: document.getElementById('includeExecutiveSummary')?.checked ?? true,
            includeFindings: document.getElementById('includeDetailedFindings')?.checked ?? true,
            includeRecommendations: document.getElementById('includeRecommendations')?.checked ?? true
        };

        // Show loading state
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';

        // Prepare request data
        const requestData = {
            format: format,
            startDate: startDate,
            endDate: endDate,
            options: options,
            stats: {
                total: document.getElementById('totalTasks')?.textContent || '0',
                completed: document.getElementById('completedTasks')?.textContent || '0',
                inProgress: document.getElementById('inProgressTasks')?.textContent || '0',
                pending: document.getElementById('pendingTasks')?.textContent || '0'
            }
        };

        // Send request
        const response = await fetch(`/client/${clientId}/generate_custom_report`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to generate report');
        }

        // Handle successful response
        const blob = await response.blob();
        const fileName = `Audit_Report_${startDate}_to_${endDate}.${format === 'excel' ? 'xlsx' : 'docx'}`;
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = fileName;
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        // Show success message
        showToast('Success', 'Report generated successfully!');

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('generateReportModal'));
        if (modal) {
            setTimeout(() => modal.hide(), 1000);
        }

    } catch (error) {
        console.error('Error generating report:', error);
        showToast('Error', error.message || 'Failed to generate report');
    } finally {
        // Reset button state
        const downloadBtn = document.getElementById('downloadReport');
        if (downloadBtn) {
            setTimeout(() => {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-download me-2"></i>Download Report';
            }, 2000);
        }
    }
}

// Add error handling helper
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger';
    errorDiv.role = 'alert';
    errorDiv.textContent = message;
    
    const previewDiv = document.getElementById('reportPreview');
    previewDiv.insertBefore(errorDiv, previewDiv.firstChild);
    
    setTimeout(() => errorDiv.remove(), 5000);
}

// Add this helper function to format dates
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

// Add progress tracking helper
function updateGenerationProgress(message, progress) {
    const progressBar = document.querySelector('.progress-bar');
    if (progressBar) {
        progressBar.style.width = `${progress}%`;
        progressBar.textContent = message;
    }
}

async function handleDeleteTask(row) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }

    const taskId = row.getAttribute('data-task-id');
    const clientId = getClientIdFromUrl();
    const deleteButton = row.querySelector('.delete-task');

    try {
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        const response = await fetch(`/client/${clientId}/delete_audit_task/${taskId}`, {
            method: 'DELETE'
        });

        const data = await response.json();
        if (data.success) {
            showToast('Success', 'Task deleted successfully');
            row.remove();
            updateTaskCounters();
        } else {
            throw new Error(data.message || 'Failed to delete task');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', error.message || 'Failed to delete task');
        deleteButton.disabled = false;
        deleteButton.innerHTML = '<i class="fas fa-trash"></i>';
    }
}

function makeRowEditable(row) {
    const cells = row.querySelectorAll('td:not(:last-child)');
    const originalValues = {};

    cells.forEach(cell => {
        const className = Array.from(cell.classList).find(c => c.startsWith('task-'));
        if (className) {
            originalValues[className] = cell.innerHTML;

            if (className === 'task-status') {
                const currentStatus = cell.textContent.trim();
                cell.innerHTML = `
                    <select class="form-select form-select-sm">
                        <option value="Pending" ${currentStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                        <option value="In Progress" ${currentStatus === 'In Progress' ? 'selected' : ''}>In Progress</option>
                        <option value="Completed" ${currentStatus === 'Completed' ? 'selected' : ''}>Completed</option>
                    </select>
                `;
            } else {
                cell.contentEditable = true;
                cell.classList.add('editing');
            }
        }
    });

    row.dataset.originalValues = JSON.stringify(originalValues);

    const actionsCell = row.querySelector('td:last-child');
    actionsCell.innerHTML = `
        <div class="btn-group btn-group-sm">
            <button class="btn btn-success save-changes">
                <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-secondary cancel-edit">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
}

async function saveChanges(row) {
    const taskId = row.getAttribute('data-task-id');
    const clientId = getClientIdFromUrl();
    const saveButton = row.querySelector('.save-changes');

    const updatedData = {
        task_name: row.querySelector('.task-name').textContent,
        procedure: row.querySelector('.task-procedure').textContent,
        audit_evidence: row.querySelector('.task-evidence').textContent,
        comments: row.querySelector('.task-comments').textContent,
        status: row.querySelector('.task-status select').value,
        allocated_team_member: row.querySelector('.task-member').textContent
    };

    try {
        saveButton.disabled = true;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        const response = await fetch(`/client/${clientId}/update_audit_task/${taskId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        });

        const data = await response.json();
        if (data.success) {
            showToast('Success', 'Changes saved successfully');
            location.reload();
        } else {
            throw new Error(data.message || 'Failed to save changes');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error', error.message || 'Failed to save changes');
        cancelEdit(row);
    }
}

function cancelEdit(row) {
    try {
        const originalValues = JSON.parse(row.dataset.originalValues);
        const cells = row.querySelectorAll('td:not(:last-child)');

        cells.forEach(cell => {
            const className = Array.from(cell.classList).find(c => c.startsWith('task-'));
            if (className && originalValues[className]) {
                cell.innerHTML = originalValues[className];
                cell.contentEditable = false;
                cell.classList.remove('editing');
            }
        });

        const actionsCell = row.querySelector('td:last-child');
        actionsCell.innerHTML = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary edit-task">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-outline-danger delete-task">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    } catch (error) {
        console.error('Error restoring row:', error);
        location.reload(); // Fallback to reload if restoration fails
    }
}

function getClientIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    const clientIdIndex = pathParts.indexOf('client') + 1;
    if (clientIdIndex > 0 && clientIdIndex < pathParts.length) {
        return pathParts[clientIdIndex];
    }
    throw new Error('Client ID not found in URL');
}

function showToast(title, message) {
    const toastEl = document.getElementById('notificationToast');
    if (!toastEl) {
        console.error('Toast element not found');
        return;
    }
    
    const toast = new bootstrap.Toast(toastEl, {
        delay: 3000
    });
    
    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastMessage').textContent = message;
    toast.show();
}

function updateTaskCounters() {
    const counters = {
        total: 0,
        completed: 0,
        inProgress: 0,
        pending: 0
    };

    document.querySelectorAll('[data-task-id]').forEach(row => {
        counters.total++;
        const status = row.querySelector('.task-status').textContent.trim();
        
        if (status === 'Completed') counters.completed++;
        else if (status === 'In Progress') counters.inProgress++;
        else counters.pending++;
    });

    Object.entries(counters).forEach(([key, value]) => {
        const element = document.getElementById(`${key}Tasks`);
        if (element) element.textContent = value;
    });
}

// Add CSS styles
const styles = `
    .editing {
        padding: 5px !important;
        background-color: #fff !important;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        min-height: 2.2em;
    }
    .editing:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    .form-select-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
    }
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
`;

// Add styles to document
const styleSheet = document.createElement("style");
styleSheet.textContent = styles;
document.head.appendChild(styleSheet);

document.addEventListener('DOMContentLoaded', function() {
    // Initialize clone execution functionality
    initializeCloneExecution();
});

function initializeCloneExecution() {
    // Initialize modal and form elements
    const cloneModal = document.getElementById('cloneExecutionModal');
    const cloneForm = document.getElementById('cloneExecutionForm');
    const sourcePeriodSelect = document.getElementById('sourcePeriod');
    const newStartDateInput = document.getElementById('newStartDate');
    const newEndDateInput = document.getElementById('newEndDate');
    const cloneButton = document.getElementById('cloneExecutionBtn');

    // Date validation function
    function validateDates(startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        
        if (start > end) {
            showToast('Error', 'End date must be after start date');
            return false;
        }
        return true;
    }

    // Add event listener for source period selection
    sourcePeriodSelect?.addEventListener('change', function() {
        if (!this.value) return;

        const [startDate, endDate] = this.value.split('|');
        const currentStart = '{{ start_date }}';
        const currentEnd = '{{ end_date }}';
        
        if (startDate === currentStart && endDate === currentEnd) {
            showToast('Warning', 'Cannot clone from current period');
            this.value = '';
            return;
        }
    });

    // Add event listeners for date inputs
    newStartDateInput?.addEventListener('change', function() {
        if (newEndDateInput.value) {
            validateDates(this.value, newEndDateInput.value);
        }
    });

    newEndDateInput?.addEventListener('change', function() {
        if (newStartDateInput.value) {
            validateDates(newStartDateInput.value, this.value);
        }
    });

    // Clone button click handler
// Update the clone button click handler
cloneButton?.addEventListener('click', async function() {
    try {
        // Get form values
        const sourcePeriodSelect = document.getElementById('sourcePeriod');
        const newStartDate = document.getElementById('newStartDate').value;
        const newEndDate = document.getElementById('newEndDate').value;

        // Validate inputs
        if (!sourcePeriodSelect.value || !newStartDate || !newEndDate) {
            showToast('Error', 'Please fill in all required fields');
            return;
        }

        // Split source period value properly
        const [sourceStartDate, sourceEndDate] = sourcePeriodSelect.value.split('|');
        if (!sourceStartDate || !sourceEndDate) {
            showToast('Error', 'Invalid source period selected');
            return;
        }

        // Validate dates
        if (!validateDates(newStartDate, newEndDate)) {
            return;
        }

        // Disable button and show loading state
        const originalButtonText = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cloning...';

        const response = await fetch(`/client/${getClientIdFromUrl()}/clone_audit_execution`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                source_start_date: sourceStartDate,
                source_end_date: sourceEndDate,
                new_start_date: newStartDate,
                new_end_date: newEndDate,
                overwrite: false
            })
        });

        const data = await response.json();

        if (data.requires_overwrite) {
            // Ask user for confirmation to overwrite
            if (confirm('Audit execution already exists for this period. Do you want to overwrite it?')) {
                // Retry with overwrite flag
                const overwriteResponse = await fetch(`/client/${getClientIdFromUrl()}/clone_audit_execution`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_start_date: sourceStartDate,
                        source_end_date: sourceEndDate,
                        new_start_date: newStartDate,
                        new_end_date: newEndDate,
                        overwrite: true
                    })
                });
                
                const overwriteData = await overwriteResponse.json();
                if (overwriteData.success) {
                    showToast('Success', 'Successfully cloned and overwrote audit execution');
                    // Close modal and redirect
                    const modal = bootstrap.Modal.getInstance(document.getElementById('cloneExecutionModal'));
                    modal.hide();
                    setTimeout(() => {
                        window.location.href = `/client/${getClientIdFromUrl()}/audit_execution?start_date=${newStartDate}&end_date=${newEndDate}`;
                    }, 1500);
                    return;
                }
            } else {
                showToast('Info', 'Clone operation cancelled');
                this.disabled = false;
                this.innerHTML = originalButtonText;
                return;
            }
        }

        if (data.success) {
            showToast('Success', data.message || 'Successfully cloned audit execution');
            // Close modal and redirect
            const modal = bootstrap.Modal.getInstance(document.getElementById('cloneExecutionModal'));
            modal.hide();
            setTimeout(() => {
                window.location.href = `/client/${getClientIdFromUrl()}/audit_execution?start_date=${newStartDate}&end_date=${newEndDate}`;
            }, 1500);
        } else {
            throw new Error(data.error || 'Failed to clone audit execution');
        }

    } catch (error) {
        console.error('Clone execution error:', error);
        showToast('Error', error.message || 'Failed to clone audit execution');
        this.disabled = false;
        this.innerHTML = originalButtonText;
    }
});

// Helper function to validate dates
function validateDates(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        showToast('Error', 'End date must be after start date');
        return false;
    }
    return true;
}

    // Reset form when modal is hidden
    cloneModal?.addEventListener('hidden.bs.modal', function() {
        cloneForm.reset();
        if (cloneButton) {
            cloneButton.disabled = false;
            cloneButton.innerHTML = 'Clone Execution';
        }
    });
}

// Helper function to show toast notifications
function showToast(title, message) {
    const toast = document.getElementById('notificationToast');
    if (!toast) {
        console.error('Toast element not found');
        return;
    }

    const toastInstance = new bootstrap.Toast(toast, {
        delay: 3000
    });

    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastMessage').textContent = message;
    toastInstance.show();
}

// Helper function to get client ID from URL
function getClientIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    const clientIndex = pathParts.indexOf('client') + 1;
    if (clientIndex > 0 && clientIndex < pathParts.length) {
        return pathParts[clientIndex];
    }
    throw new Error('Client ID not found in URL');
}

// Add this if you want to format dates in the UI
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

// Add event listeners for any date inputs that need formatting
document.querySelectorAll('input[type="date"]').forEach(input => {
    input.addEventListener('change', function() {
        if (this.value) {
            const formattedDate = formatDate(this.value);
            this.setAttribute('data-formatted-date', formattedDate);
        }
    });
});
// Document Upload Functions
function openUploadModal(taskId) {
    document.getElementById('taskIdForUpload').value = taskId;
    document.getElementById('selectedFiles').innerHTML = '';
    const fileInput = document.querySelector('#uploadDocForm input[type="file"]');
    fileInput.value = '';
    
    // Add file selection preview
    fileInput.addEventListener('change', updateFileList);
    
    const modal = new bootstrap.Modal(document.getElementById('uploadDocModal'));
    modal.show();
}

function updateFileList(event) {
    const files = event.target.files;
    const fileList = document.getElementById('selectedFiles');
    fileList.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'selected-file d-flex align-items-center mb-2 p-2 border rounded';
        
        const iconClass = getFileIconClass(file.type);
        const fileSize = formatFileSize(file.size);
        
        fileDiv.innerHTML = `
            <i class="fas ${iconClass} me-2"></i>
            <div class="flex-grow-1">
                <div class="fw-bold">${file.name}</div>
                <small class="text-muted">${getFileType(file.type)} - ${fileSize}</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        fileList.appendChild(fileDiv);
    });
}

function removeFile(index) {
    const fileInput = document.querySelector('#uploadDocForm input[type="file"]');
    const dt = new DataTransfer();
    
    Array.from(fileInput.files).forEach((file, i) => {
        if (i !== index) dt.items.add(file);
    });
    
    fileInput.files = dt.files;
    updateFileList({ target: fileInput });
}

async function uploadDocuments() {
    const form = document.getElementById('uploadDocForm');
    const formData = new FormData();  // Create new FormData instance
    const taskId = document.getElementById('taskIdForUpload').value;
    const clientId = getClientIdFromUrl();
    
    try {
        const uploadButton = document.querySelector('#uploadDocModal .btn-primary');
        uploadButton.disabled = true;
        uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

        // Add task_id and other form fields
        formData.append('task_id', taskId);
        formData.append('doc_title', form.querySelector('[name="doc_title"]').value);
        formData.append('doc_description', form.querySelector('[name="doc_description"]').value);

        // Add files
        const files = form.querySelector('input[type="file"]').files;
        Array.from(files).forEach(file => {
            formData.append('documents', file);  // Use 'documents' consistently
        });

        const response = await fetch(`/client/${clientId}/task/${taskId}/upload-documents`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        
        if (result.success) {
            showToast('Success', `${result.uploaded_count} documents uploaded successfully`);
            bootstrap.Modal.getInstance(document.getElementById('uploadDocModal')).hide();
            location.reload();
        } else {
            throw new Error(result.error || 'Failed to upload documents');
        }
    } catch (error) {
        showToast('Error', error.message);
    } finally {
        uploadButton.disabled = false;
        uploadButton.innerHTML = 'Upload';
    }
}
function uploadMoreDocuments() {
    const taskId = document.querySelector('#docsTable').dataset.taskId;
    bootstrap.Modal.getInstance(document.getElementById('viewDocsModal')).hide();
    openUploadModal(taskId);
}

async function viewDocuments(taskId) {
    const clientId = getClientIdFromUrl();
    try {
        const response = await fetch(`/client/${clientId}/task/${taskId}/documents`);
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.querySelector('#docsTable tbody');
            tbody.innerHTML = '';
            document.querySelector('#docsTable').dataset.taskId = taskId;
            
            result.documents.forEach(doc => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas ${getFileIconClass(doc.mime_type)} me-2"></i>
                            ${doc.title}
                        </div>
                    </td>
                    <td>${getFileType(doc.mime_type)}</td>
                    <td>${formatFileSize(doc.size)}</td>
                    <td>${doc.description || '-'}</td>
                    <td>${new Date(doc.uploaded_at).toLocaleString()}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-primary" onclick="downloadTaskDocument('${doc._id}')" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-danger" onclick="deleteTaskDocument('${doc._id}', '${taskId}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            const modal = new bootstrap.Modal(document.getElementById('viewDocsModal'));
            modal.show();
        } else {
            throw new Error(result.error || 'Failed to fetch documents');
        }
    } catch (error) {
        showToast('Error', error.message);
    }
}

// Helper functions for file type and size
function getFileIconClass(mimeType) {
    const iconMap = {
        'application/pdf': 'fa-file-pdf',
        'application/msword': 'fa-file-word',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'fa-file-word',
        'application/vnd.ms-excel': 'fa-file-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'fa-file-excel',
        'image/': 'fa-file-image',
        'text/': 'fa-file-alt'
    };

    for (const [type, icon] of Object.entries(iconMap)) {
        if (mimeType.startsWith(type)) return icon;
    }
    return 'fa-file';
}

function getFileType(mimeType) {
    const typeMap = {
        'application/pdf': 'PDF',
        'application/msword': 'Word',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Word',
        'application/vnd.ms-excel': 'Excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Excel',
        'image/jpeg': 'JPEG',
        'image/png': 'PNG',
        'text/plain': 'Text'
    };

    return typeMap[mimeType] || mimeType.split('/')[1].toUpperCase();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}
async function downloadTaskDocument(docId) {
    const clientId = getClientIdFromUrl();
    try {
        showToast('Info', 'Starting download...');
        
        const response = await fetch(`/client/${clientId}/task-document/${docId}/download`);
        
        if (!response.ok) {
            throw new Error('Failed to download file');
        }
        
        const blob = await response.blob();
        
        // Get filename from Content-Disposition header
        let filename = 'download';
        const disposition = response.headers.get('Content-Disposition');
        if (disposition && disposition.includes('filename*=UTF-8')) {
            const filenameMatch = disposition.match(/filename\*=UTF-8''(.+)/);
            if (filenameMatch && filenameMatch[1]) {
                filename = decodeURIComponent(filenameMatch[1]);
            }
        } else if (disposition && disposition.includes('filename=')) {
            const filenameMatch = disposition.match(/filename="?([^"]+)"?/);
            if (filenameMatch && filenameMatch[1]) {
                filename = filenameMatch[1];
            }
        }
        
        // Create and trigger download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast('Success', 'Download completed');
    } catch (error) {
        console.error('Download error:', error);
        showToast('Error', 'Failed to download file');
    }
}

async function deleteTaskDocument(docId, taskId) {
    if (!confirm('Are you sure you want to delete this document?')) return;
    
    const clientId = getClientIdFromUrl();
    try {
        const response = await fetch(`/client/${clientId}/task-document/${docId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('Success', 'Document deleted successfully');
            // Refresh the documents list
            viewDocuments(taskId);
        } else {
            throw new Error(result.error || 'Failed to delete document');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showToast('Error', error.message);
    }
}
</script>

{% endblock %}